include ../config.mk


# EXTRA_PACKS=-package base-3.0.3.1 -package parsec-2.1.0.1
# EXTRA_PACKS=-package base-3.0.3.2 -package parsec-2.1.0.1
# GHC_COMMAND=ghc-6.8.3

include Makefile-defs

###############################################################################

MAIN = Inter/Super.cgi
TRIAL = Inter/Trial.cgi

CGIS = $(MAIN) $(TRIAL)

all : $(CGIS)

control : 
	( cd control && make autoan.cgi )

score :
	$(GHC_COMMAND) $(EXTRA_PACKS)  \
		Scorer/Main.hs -o Scorer/ScorerDB

rescore :
	$(GHC_COMMAND) $(EXTRA_PACKS)  \
		Inter/Rescore.hs -o Inter/Rescore

#########################################################################
# tags
#########################################################################

tags :
	rm -f TAGS && \
	find . \( -name "*.hs" -o -name "*.hs.drift" \) \
	 -print -exec etags -a {} \;


#######################################################################
# haddock
# note: HADDOCK will be set by configure in config.mk
#######################################################################

# GHC_VERSION = 6.4.2.20060121
# GHC_VERSION = 6.6
# GHC_VERSION = 6.8.0.20070921
GHC_VERSION = 6.8.3

GHC_LIBS = base haskell98 parsec unix network readline containers pretty
GHC_LINK = http://www.haskell.org/ghc/docs/$(GHC_VERSION)/html/libraries
GHC_DESC = /usr/local/share/doc/ghc/libraries

HAXML_LINK = http://www.cs.york.ac.uk/fp/HaXml
# HAXML_DESC = /usr/local/share/ghc-$(GHC_VERSION)/html/libraries/HaXml
HAXML_DESC = /usr/local/share/doc/HaXml-1.13.2/html

AUTOLIB_LINK = http://141.57.11.163/auto/lib/haddock
# AUTOLIB_DESC = /usr/local/share/ghc-$(GHC_VERSION)/html/libraries/Autolib
AUTOLIB_DESC = /usr/local/share/doc/Autolib-0.0/html

HADDOCK_OUTPUT = $(WWW)/auto/tool/haddock

HADDOCK_OPTS = -v \
-B /usr/local/lib/ghc-$(GHC_VERSION) \
--optghc=-fglasgow-exts \
--optghc=-fallow-undecidable-instances \
--optghc=-fallow-overlapping-instances \
--html \
--title=auto/tool \
--source-base=http://141.57.11.163/cgi-bin/cvsweb/tool/src \
--source-module=http://141.57.11.163/cgi-bin/cvsweb/tool/src/%F \
$(foreach lib,$(GHC_LIBS), \
--read-interface=$(GHC_LINK)/$(lib),$(GHC_DESC)/$(lib)/$(word 1,$(subst -, ,$(lib))).haddock) \
--read-interface=$(AUTOLIB_LINK),$(AUTOLIB_DESC)/Autolib.haddock \
--read-interface=$(HAXML_LINK)/HaXml,$(HAXML_DESC)/HaXml.haddock 

GHC_DEFINES = $(shell ./ghc-defs.sh)

haddock :
	rm -rf doc
	mkdirhier doc
	for file in `find . -name "*.hi" -print | sed -e 's/hi$$/hs/'`; \
		do  \
			mkdir -p $$(dirname doc/$$file) ; \
			cpp -P -traditional $(GHC_DEFINES) $(HDDEFS) $$file \
			| grep -v "Id: " > doc/$$file; \
		done 
	mkdirhier $(HADDOCK_OUTPUT) 
	cd doc ; ( find . -name "*.hs" -print | egrep -v "Inter/Super|Inter/Trial" ) \
	| xargs $(HADDOCK) $(HADDOCK_OPTS) -o $(HADDOCK_OUTPUT)

.PHONY : haddock

###############################################################################
# for drift 
# note: AUTODRIFT will be set by configure in config.mk
###############################################################################

DRIFT = $(basename $(shell find . -name "*.hs.drift" -print))

%.hs : %.hs.drift
	$(AUTODRIFT) $< | egrep -v "^{-.*Generated by" > $@

drift : $(DRIFT) 

drift-clean :
	rm -f `find . -name "*.drift" -print | sed s/.drift$$// `


###############################################################################
# cgi Inter/Face
###############################################################################


install : $(MAIN) $(TRIAL) 
	cp $(MAIN) $(CGI)/$(CGINAME)
	cp $(TRIAL) $(CGI)/

.PHONY : do

###############################################################################

.PHONY: objclean clean

forall = $(foreach DIR,$(DIRS),$(MAKE) -C $(DIR) $(1);)

objclean:
	rm -f `find . -name '*.o'`
	rm -f `find . -name '*.hi'`
	rm -f `find . -name '*.cgi'`
#	$(call forall,$@)

clean: objclean
#	$(call forall,$@)
