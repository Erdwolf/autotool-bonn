######################################################################
# install-specific things
######################################################################

ifeq ($(shell hostname), theo1)
EXTRA_PACKS = -package hsql
GHC = ghc-6.2
CGIDIR = /var/www/matchbox
endif

ifeq ($(shell hostname), afa)
EXTRA_PACKS = -package hsql
GHC = ghc
endif

ifeq ($(shell hostname), nfa)
EXTRA_PACKS = -package hsql
GHC = ghc-6.2
endif

ifeq ($(shell hostname), dfa)
EXTRA_PACKS = -package hsql
GHC = ghc6 # which is 6.0.1, actually
endif

ifeq ($(shell hostname), aaron)
# EXTRA_PACKS = -package-conf /home/alf/autotool/autotool.pkg -package hsql
EXTRA_PACKS = -package hsql
GHC = ghc-6.2
endif


########################################################################
# defaults
########################################################################

ifndef GHC
GHC = ghc
endif

# System spezifische Einstellung

#
# enthält absolute Pfadangaben --> erlaube Überschreibung durch andere Makefiles
# (besonders aus anderen Verzeichnissen), dazu z.B. in ./control/Makefile
#
# RELATIV_TO_MAIN_DIR=..
# DIRS = $(RELATIV_TO_MAIN_DIR)/wash
# include ../Makefile-defs, 
# 
# 
ifndef RELATIV_TO_MAIN_DIR
RELATIV_TO_MAIN_DIR =.
endif


ifndef EXTRA_PACKS
EXTRA_PACKS = -package-conf $(RELATIV_TO_MAIN_DIR)/autotool.pkg -package hsql 
endif

ifndef DEFINES
#DEFINES = -DHOME=1
endif

# erlaube überschreibung, s.o
ifndef DIRS
DIRS = util:wash:control:bridge:challenger:ws03/aus:
endif

########################################################################
# ugly ugly ugly : system-spezifische teile des makefiles

########################################################################
# ghc / ghci : setup
########################################################################


FLAGS = -fallow-overlapping-instances \
	-fglasgow-exts \
	-fallow-undecidable-instances 

# PACKS = -package text -package data -package posix -package network 
PACKS = 

OPT = -O2 -fvia-C -funbox-strict-fields -fnumbers-strict # -fdicts-strict

# PROF = -prof -auto-all -auto-dicts

WARN =  -Werror -dcore-lint

GHC_COMMAND = $(GHC) --make \
	$(WARN) $(OPT) $(PROF) $(PACKS) $(FLAGS) $(DEFINES) -i$(DIRS)

GHCI_COMMAND = 	$(GHC) --interactive \
	$(WARN) $(PACKS) $(FLAGS) $(DEFINES) -i$(DIRS)

all:

#########################################################################
# Implicit rules
#########################################################################

# build haskell-cgis, we need hsql stuff too 
%.cgi : do %.hs
	$(GHC_COMMAND)  $(EXTRA_PACKS)  $*.hs -o $@




#########################################################################
# cvs shorthands
#########################################################################

cvs-update:
	cvs update -d 2>&1 | tee cvs.log
	make drift

cvs-update-log: 
	cat cvs.log | grep -E '^[A-Z] '

cvs-status:
	cvs status 2>&1 | grep "File:" | grep -v "Up-to-date"
